<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Image to PDF</title>
    <style type="text/css">
        html, body {
            margin: 0px;
            padding: 0px;
        }
        button {
            font-size: 1em;
            padding: 0px;
            margin: 0px;
            border: 0px;
            font-family: sans-serif;
            background: #FFF;
            color: #000;
            padding-left: 0.2em;
            padding-right: 0.2em;
            border-radius: 0.2em;
            cursor: pointer;
        }
        button:hover {
            background: #AAA;
        }
    </style>
  </head>
  <body style="background: #2D3033; color: #D2D6C1; font-family: sans-serif;">
    <div style="padding: 0.75em;">
        <input id="files-input" type="file" multiple style="display:none">
        <div>Image(s): <button onclick="document.getElementById('files-input').click()">ファイルを追加</button></div>
        <br>
        <div id="files-preview"></div>
        <div><button id="create-button">PDF に変換</button></div>
        <br>
        <div><a id="result-url"></a></div>
        <div style="height:2em"></div>
    </div>
    <script type="text/javascript">
        ~async function() {
            const fileList = [];
            const result = document.getElementById("result-url");
            const input = document.getElementById("files-input");
            const preview = document.getElementById("files-preview");
            const creationButton = document.getElementById("create-button");
            const worker = new Worker("./worker.js", { type: "module" });

            function img2pdf(fileBytes) {
                return new Promise((resolve, reject) => {
                    const msgId = `${Date.now() % 10000000 + Math.random()}`;
                    worker.addEventListener("message", e => {
                        if (e.data.msgId !== msgId) return;
                        if (e.data.error !== null) {
                            reject(e.data.error);
                            return;
                        }
                        resolve(e.data.pdf);
                    });
                    worker.postMessage({ msgId, fileBytes }, { transfer: fileBytes });
                });
            }

            const objectUrl = new WeakMap();
            function createObjectURLWithCache(file) {
                const url = objectUrl.get(file);
                if (url) return url;
                const newUrl = URL.createObjectURL(file);
                objectUrl.set(file, newUrl);
                return newUrl;
            }
            input.addEventListener("input", () => {
                if (!input.files.length) return;
                fileList.push(...input.files);
                updateFilePreview();
            });

            function updateFilePreview() {
                preview.textContent = "";
                for (const f of fileList) {
                    const container = document.createElement("div");

                    const nameSpan = document.createElement("span");
                    nameSpan.textContent = f.name;
                    nameSpan.style.wordBreak = "break-word";
                    container.appendChild(nameSpan);

                    const deletionButton = document.createElement("button");
                    deletionButton.textContent = "削除";
                    deletionButton.addEventListener("click", () => {
                        const index = fileList.indexOf(f);
                        fileList.splice(index, 1);
                        container.remove();
                    });
                    container.appendChild(deletionButton);

                    container.appendChild(document.createElement("br"));

                    const img = new Image();
                    img.src = createObjectURLWithCache(f);
                    img.alt = "？？？";
                    img.style.maxWidth = "100%";
                    img.style.width = "17rem";
                    container.appendChild(img);

                    preview.appendChild(container);
                }
            }

            creationButton.addEventListener("click", async () => {
                try { URL.revokeObjectURL(result.href); } catch(_) { /* ignore errors */ }
                result.href = "javascript:void(0)";
                result.style.color = "#0FF";
                result.textContent = "processing...";
                result.style.cursor = "default";
                result.removeAttribute("download");
                if (!fileList.length) {
                    result.textContent = "No image";
                    result.style.color = "#F00";
                    return;
                }
                try {
                    const fileBytes = await Promise.all(fileList.map(v => v.arrayBuffer()));
                    const pdfData = await img2pdf(fileBytes);
                    const filename = `${Date.now()}.pdf`;
                    const fileUrl = URL.createObjectURL(new File([pdfData], filename, { type: "application/pdf" }));
                    result.style.cursor = "";
                    result.style.color = "#0F0";
                    result.href = fileUrl;
                    result.textContent = fileUrl;
                    result.download = filename;
                } catch(e) {
                    result.textContent = e;
                    result.style.color = "#F00";
                }
            });
        }();
    </script>
  </body>
</html>
