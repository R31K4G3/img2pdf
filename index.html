<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Image to PDF</title>
  </head>
  <body style="background: #2D3033; color: #D2D6C1;">
    <div>Image(s): <input id="files-input" type="file" multiple disabled><span id="filenames"></span></div>
    <div><a id="result" style="color:#0FF"></a></div>
    <script type="text/javascript">
      ~async function() {
        const result = document.getElementById("result");
        const input = document.getElementById("files-input");
        const filenames = document.getElementById("filenames");
        const worker = new Worker("./worker.js", { type: "module" });

        function img2pdf(fileBytes) {
          return new Promise((resolve, reject) => {
            const msgId = `${Date.now() % 10000000 + Math.random()}`;
            worker.addEventListener("message", e => {
              if (e.data.msgId !== msgId) return;
              if (e.data.error !== null) {
                reject(e.data.error);
                return;
              }
              resolve(e.data.pdf);
            });
            worker.postMessage(fileBytes, { transfer: fileBytes });
          });
        }

        input.addEventListener("input", async () => {
          try { URL.revokeObjectURL(result.href); } catch(_) { /* ignore errors */ }
          result.href = "javascript:void(0)";
          result.textContent = "processing...";
          result.removeAttribute("download");
          try {
            const files = [...input.files];
            filenames.textContent = files.map(v => v.name).join(", ")
            const fileBytes = await Promise.all(files.map(v => v.arrayBuffer()));
            const pdfData = await img2pdf(fileBytes);
            const filename = `${Date.now()}.pdf`;
            const fileUrl = URL.createObjectURL(new File([pdfData], filename, { type: "application/pdf" }));
            result.href = fileUrl;
            result.textContent = fileUrl;
            result.download = filename;
          } catch(e) {
            result.textContent = e;
          }
        });

        input.disabled = false;
      }();
    </script>
  </body>
</html>
